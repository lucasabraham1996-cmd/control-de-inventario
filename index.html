<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Inventario y Stock</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Librer√≠a para generar archivos Excel (.xlsx) -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal { transition: opacity 0.3s ease, visibility 0.3s ease; z-index: 50; }
        .modal:not(.is-open) { opacity: 0; visibility: hidden; }
        .modal.is-open { opacity: 1; visibility: visible; }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: none; border-radius: 0.375rem; }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
        }
        .accordion-content.open {
             transition: max-height 0.3s ease-in;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="bg-blue-700 text-white p-4 md:p-6 rounded-2xl shadow-lg mb-8 flex items-center gap-4">
            <img src="logoic.png" alt="Logo" class="h-12 w-12 md:h-16 md:w-16 object-contain">
            <div>
                <h1 class="text-2xl md:text-4xl font-bold">Sistema de Control de Inventario</h1>
                <p class="text-blue-200 mt-1">Gestiona el stock de tu material institucional de forma centralizada.</p>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-lg">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold mb-4 sm:mb-0">Inventario por Categor√≠as</h2>
                    <div class="flex flex-wrap gap-2">
                        <button id="open-add-product-modal" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition duration-300 flex items-center gap-2">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                            Agregar Producto
                        </button>
                        <button id="open-register-entry-modal" class="bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-purple-700 transition duration-300 flex items-center gap-2">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L10 14.414l-7.707-7.707A1 1 0 012 6V3a1 1 0 011-1zm0 5.414L9.293 15.707a1 1 0 001.414 0L17 8.414V17a1 1 0 01-1 1H4a1 1 0 01-1-1V8.414z" clip-rule="evenodd" /></svg>
                            Registrar Entrada
                        </button>
                        <button id="open-register-exit-modal" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 transition duration-300 flex items-center gap-2">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 2a4 4 0 00-4 4v1H5a1 1 0 00-.993.883L4 8v9a1 1 0 001 1h10a1 1 0 001-1V8l-.007-.117A1 1 0 0015 7h-1V6a4 4 0 00-4-4zm2 5V6a2 2 0 10-4 0v1h4zm-6 3a1 1 0 011 1v3a1 1 0 11-2 0v-3a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                            Registrar Salida
                        </button>
                    </div>
                </div>
                <div id="inventory-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <p class="text-center py-8 text-gray-500 md:col-span-2">Cargando categor√≠as...</p>
                </div>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-semibold mb-6">Historial de Movimientos</h2>
                <div id="movements-history" class="space-y-2 max-h-[600px] overflow-y-auto">
                    <p class="text-center py-8 text-gray-500">No hay movimientos registrados.</p>
                </div>
            </div>
        </main>
        
        <footer class="text-center mt-8">
            <button id="export-excel-btn" class="bg-green-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-green-800 transition duration-300 flex items-center gap-3 mx-auto">
                <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M17 3H7C4.79086 3 3 4.79086 3 7V17C3 19.2091 4.79086 21 7 21H17C19.2091 21 21 19.2091 21 17V7C21 4.79086 19.2091 3 17 3ZM7 1C3.13401 1 0 4.13401 0 8V16C0 19.866 3.13401 23 7 23H17C20.866 23 24 19.866 24 16V8C24 4.13401 20.866 1 17 1H7Z" fill="white"/><path d="M14.5303 10.5303C14.8232 10.2374 14.8232 9.76256 14.5303 9.46967C14.2374 9.17678 13.7626 9.17678 13.4697 9.46967L10.5 12.4393L8.53033 10.4697C8.23744 10.1768 7.76256 10.1768 7.46967 10.4697C7.17678 10.7626 7.17678 11.2374 7.46967 11.5303L9.96967 14.0303C10.2626 14.3232 10.7374 14.3232 11.0303 14.0303L14.5303 10.5303Z" fill="white"/></svg>
                Descargar Reporte en Excel
            </button>
        </footer>
    </div>

    <!-- Modals -->
    <div id="add-product-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-2xl transform transition-transform duration-300 scale-95">
             <h3 class="text-2xl font-semibold mb-6">Agregar Nuevo Producto/Categor√≠a</h3>
            <form id="add-product-form" class="space-y-4">
                <div>
                    <label class="block text-gray-700 font-medium mb-2">Categor√≠a</label>
                    <select id="add-product-category" required class="w-full p-3 border border-gray-300 rounded-lg">
                        <option value="">Seleccionar categor√≠a...</option>
                        <option value="new">-- Crear Nueva Categor√≠a --</option>
                    </select>
                </div>
                <div id="new-category-fields" class="hidden space-y-4 border p-4 rounded-lg">
                    <input type="text" id="new-category-name" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="Nombre Nueva Categor√≠a">
                    <input type="text" id="new-category-emoji" class="w-full p-3 border border-gray-300 rounded-lg text-center text-xl" placeholder="Emoji para la Categor√≠a üìÇ">
                </div>

                <div id="product-fields" class="space-y-4 border p-4 rounded-lg">
                    <input type="text" id="add-product-name" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="Nombre del Producto">
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <input type="number" id="add-initial-stock" min="0" value="0" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="Stock Inicial">
                        <input type="text" id="add-product-emoji" class="w-full p-3 border border-gray-300 rounded-lg text-center text-xl" placeholder="Emoji Producto üì¶">
                        <input type="color" id="add-product-color" value="#ffffff" class="w-full h-[46px] p-1 border border-gray-300 rounded-lg cursor-pointer">
                    </div>
                </div>
                <div class="responsible-section-container"></div>
                <div class="flex justify-end space-x-4">
                    <button type="button" class="close-modal-btn px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancelar</button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">Guardar</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="edit-movement-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
         <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-2xl transform transition-transform duration-300 scale-95">
             <h3 class="text-2xl font-semibold mb-6">Editar Movimiento</h3>
             <form id="edit-movement-form" class="space-y-4">
                 <input type="hidden" id="edit-movement-id">
                 <input type="hidden" id="edit-movement-type">
                 <input type="hidden" id="original-movement-items">
                 <input type="text" id="edit-movement-reason" required class="w-full p-3 border border-gray-300 rounded-lg" placeholder="Motivo o Evento">
                 <input type="text" id="edit-movement-search" placeholder="Escribe para buscar un producto..." class="w-full p-3 border border-gray-300 rounded-lg">
                 <div id="edit-movement-items-container" class="max-h-48 overflow-y-auto space-y-3 pr-2"></div>
                 <div class="responsible-section-container"></div>
                 <div class="flex justify-end space-x-4 mt-4">
                     <button type="button" class="close-modal-btn px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancelar</button>
                     <button type="submit" class="px-6 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 font-semibold">Actualizar Movimiento</button>
                 </div>
             </form>
         </div>
     </div>
    
    <div id="register-entry-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-2xl transform transition-transform duration-300 scale-95">
            <h3 class="text-2xl font-semibold mb-6">Registrar Entrada de Material</h3>
            <form id="register-entry-form" class="space-y-4">
                <input type="text" id="entry-reason" required class="w-full p-3 border border-gray-300 rounded-lg" placeholder="Motivo (Ej: Compra #123)">
                <input type="text" id="entry-search" placeholder="Escribe para buscar un producto..." class="w-full p-3 border border-gray-300 rounded-lg">
                <div id="entry-items-container" class="max-h-48 overflow-y-auto space-y-3 pr-2"></div>
                <div class="responsible-section-container"></div>
                <div class="flex justify-end space-x-4 mt-4">
                    <button type="button" class="close-modal-btn px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancelar</button>
                    <button type="submit" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-semibold">Registrar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="register-exit-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-2xl transform transition-transform duration-300 scale-95">
            <h3 class="text-2xl font-semibold mb-6">Registrar Salida de Material</h3>
            <form id="register-exit-form" class="space-y-4">
                <input type="text" id="exit-reason" required class="w-full p-3 border border-gray-300 rounded-lg" placeholder="Nombre del Evento o Acci√≥n">
                <input type="text" id="exit-search" placeholder="Escribe para buscar un producto..." class="w-full p-3 border border-gray-300 rounded-lg">
                <div id="exit-items-container" class="max-h-48 overflow-y-auto space-y-3 pr-2"></div>
                <div class="responsible-section-container"></div>
                <div class="flex justify-end space-x-4 mt-4">
                    <button type="button" class="close-modal-btn px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancelar</button>
                    <button type="submit" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold">Registrar</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="adjust-stock-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md transform transition-transform duration-300 scale-95">
            <h3 class="text-2xl font-semibold mb-6">Editar Producto</h3>
            <form id="adjust-stock-form" class="space-y-4">
                <input type="hidden" id="adjust-stock-product-id">
                <input type="text" id="adjust-product-name" required class="w-full p-3 border border-gray-300 rounded-lg" placeholder="Nombre del Producto">
                 <div>
                    <label for="adjust-product-category" class="block text-gray-700 font-medium mb-2">Categor√≠a</label>
                    <select id="adjust-product-category" required class="w-full p-3 border border-gray-300 rounded-lg"></select>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                     <input type="number" id="new-stock-quantity" min="0" required class="w-full p-3 border border-gray-300 rounded-lg" placeholder="Stock">
                     <input type="text" id="adjust-product-emoji" class="w-full p-3 border border-gray-300 rounded-lg text-center text-xl" placeholder="Emoji üì¶">
                     <input type="color" id="adjust-product-color" class="w-full h-[46px] p-1 border border-gray-300 rounded-lg cursor-pointer">
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" class="close-modal-btn px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancelar</button>
                    <button type="submit" class="px-6 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 font-semibold">Actualizar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Custom Alert and Confirm Modals -->
    <div id="alert-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-sm text-center transform transition-transform duration-300 scale-95">
            <p id="alert-message" class="mb-6 text-lg"></p>
            <button id="alert-ok-btn" class="px-8 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">OK</button>
        </div>
    </div>

    <div id="confirm-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-sm text-center transform transition-transform duration-300 scale-95">
            <p id="confirm-message" class="mb-6 text-lg"></p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-cancel-btn" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancelar</button>
                <button id="confirm-ok-btn" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold">Confirmar</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, writeBatch, getDocs, Timestamp, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAs_LyHNTXEM40bnFMRVYF0FvAcfY4upJw",
            authDomain: "control-de-inventario-a6a98.firebaseapp.com",
            projectId: "control-de-inventario-a6a98",
            storageBucket: "control-de-inventario-a6a98.appspot.com",
            messagingSenderId: "845532432483",
            appId: "1:845532432483:web:ed38fcc4cad0537203d056",
            measurementId: "G-7VVWLJG9P6"
        };

        const appId = firebaseConfig.appId; 
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const productsCollection = collection(db, `/artifacts/${appId}/public/data/products`);
        const movementsCollection = collection(db, `/artifacts/${appId}/public/data/movements`);
        const peopleCollection = collection(db, `/artifacts/${appId}/public/data/people`);
        const categoriesCollection = collection(db, `/artifacts/${appId}/public/data/categories`);

        let productsCache = [], peopleCache = [], movementsCache = [], categoriesCache = [];
        let expandedCategories = new Set();
        let expandedMovements = new Set();
        let confirmCallback = null;

        const modals = {
            addProduct: document.getElementById('add-product-modal'),
            registerEntry: document.getElementById('register-entry-modal'),
            registerExit: document.getElementById('register-exit-modal'),
            adjustStock: document.getElementById('adjust-stock-modal'),
            editMovement: document.getElementById('edit-movement-modal'),
            alert: document.getElementById('alert-modal'),
            confirm: document.getElementById('confirm-modal'),
        };

        const openModal = (modal) => {
            modal.classList.add('is-open');
            setTimeout(() => modal.querySelector('div').classList.remove('scale-95'), 10);
        };
        const closeModal = (modal) => {
            if (!modal) return;
            modal.querySelector('div').classList.add('scale-95');
            setTimeout(() => modal.classList.remove('is-open'), 300);
        };

        function showAlert(message) {
            modals.alert.querySelector('#alert-message').textContent = message;
            openModal(modals.alert);
        }

        function showConfirm(message, callback) {
            confirmCallback = callback;
            modals.confirm.querySelector('#confirm-message').textContent = message;
            openModal(modals.confirm);
        }

        document.getElementById('alert-ok-btn').addEventListener('click', () => closeModal(modals.alert));
        document.getElementById('confirm-cancel-btn').addEventListener('click', () => {
            confirmCallback = null;
            closeModal(modals.confirm);
        });
        document.getElementById('confirm-ok-btn').addEventListener('click', () => {
            if (confirmCallback) confirmCallback();
            confirmCallback = null;
            closeModal(modals.confirm);
        });
        
        document.getElementById('open-add-product-modal').addEventListener('click', () => openModal(modals.addProduct));
        document.getElementById('open-register-entry-modal').addEventListener('click', () => { renderMovementForm(productsCache, 'entry'); openModal(modals.registerEntry); });
        document.getElementById('open-register-exit-modal').addEventListener('click', () => { renderMovementForm(productsCache, 'exit'); openModal(modals.registerExit); });
        document.querySelectorAll('.close-modal-btn').forEach(btn => btn.addEventListener('click', () => closeModal(btn.closest('.modal'))));
        
        const initialCategories = [ { name: 'Folleter√≠a', emoji: 'üìÑ' }, { name: 'Cuadernos', emoji: 'üìì' }, { name: 'Carpetas', emoji: 'üìÅ' }, { name: 'Anotadores', emoji: 'üìù' }, { name: 'Institucional', emoji: 'üè¢' } ];
        const initialProducts = [ { name: 'Folleter√≠a institucional', stock: 1000, category: 'Folleter√≠a' }, { name: 'Dossier institucional', stock: 300, category: 'Institucional' }, { name: 'Carpetas', stock: 800, category: 'Carpetas' }, { name: 'Anotadores IC', stock: 400, category: 'Anotadores' }, { name: 'Anotadores CCAP', stock: 400, category: 'Anotadores' }, { name: 'Cuadernos IC', stock: 200, category: 'Cuadernos' }, { name: 'Cuadernos CCAP', stock: 200, category: 'Cuadernos' }, { name: 'Recursos Humanos', stock: 500, color: '#b388c2', category: 'Folleter√≠a' }, { name: 'Analista de Sistemas', stock: 500, color: '#00b1e1', category: 'Folleter√≠a' }, { name: 'Higiene y Seguridad Laboral', stock: 500, color: '#f4c01e', category: 'Folleter√≠a' }, { name: 'Administraci√≥n de Empresas', stock: 500, color: '#8da248', category: 'Folleter√≠a' }, { name: 'Marketing', stock: 500, color: '#fa5d0f', category: 'Folleter√≠a' }, { name: 'Desarrollo Web y Aplicaciones Digitales', stock: 500, color: '#a8927d', category: 'Folleter√≠a' }, { name: 'Gesti√≥n Inmobiliaria', stock: 500, color: '#bb242a', category: 'Folleter√≠a' }, { name: 'Ciencia de Datos e IA', stock: 500, color: '#2d4693', category: 'Folleter√≠a' } ];
        const initialPeople = [{ name: 'Lucas Abraham' }, { name: 'Juan Cruz Darr√©' }, { name: 'Gonzalo Moreno' }];
        
        async function seedData() {
            const catSnap = await getDocs(query(categoriesCollection));
            let allCats = catSnap.docs.map(d => ({id: d.id, ...d.data()}));
            if (catSnap.empty) {
                const batch = writeBatch(db);
                initialCategories.forEach(item => batch.set(doc(categoriesCollection), item));
                await batch.commit();
                const newCatSnap = await getDocs(query(categoriesCollection));
                allCats = newCatSnap.docs.map(d => ({id: d.id, ...d.data()}));
            }

            const prodSnap = await getDocs(query(productsCollection));
            if (prodSnap.empty && allCats.length > 0) {
                const categoryMap = Object.fromEntries(allCats.map(c => [c.name, c.id]));
                const batch = writeBatch(db);
                initialProducts.forEach(p => {
                    const { category, ...productData } = p;
                    if(categoryMap[category]) {
                        productData.categoryId = categoryMap[category];
                        if (p.category === 'Folleter√≠a' && !productData.name.toLowerCase().includes('folleter√≠a')) {
                            productData.name = `Folleter√≠a - ${productData.name}`;
                        }
                        batch.set(doc(productsCollection), productData);
                    }
                });
                await batch.commit();
            }
             const peopleSnap = await getDocs(query(peopleCollection));
            if (peopleSnap.empty) {
                const batch = writeBatch(db);
                initialPeople.forEach(item => batch.set(doc(peopleCollection), item));
                await batch.commit();
            }
        }
        
        function renderInventory() {
            const container = document.getElementById('inventory-container');
            if (categoriesCache.length === 0) {
                 container.innerHTML = `<p class="text-center py-8 text-gray-500 md:col-span-2">No hay categor√≠as. Agrega un producto para empezar.</p>`;
                 return;
            }
            container.innerHTML = categoriesCache.map(category => {
                const productsInCategory = productsCache.filter(p => p.categoryId === category.id);
                const isExpanded = expandedCategories.has(category.id);
                return `
                <div class="rounded-lg shadow-md overflow-hidden">
                    <div class="category-header flex justify-between items-center p-4 cursor-pointer bg-blue-700 text-white" data-id="${category.id}">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">${category.emoji || 'üìÅ'}</span>
                            <h3 class="font-bold text-lg">${category.name}</h3>
                            <span class="text-sm bg-white text-blue-700 font-semibold px-2 py-0.5 rounded-full">${productsInCategory.length}</span>
                        </div>
                        <svg class="arrow-icon h-6 w-6 transition-transform ${isExpanded ? 'rotate-180' : ''}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    </div>
                    <div class="products-list accordion-content bg-white ${isExpanded ? 'open' : ''}" style="max-height: ${isExpanded ? '1000px' : '0px'};">
                        ${productsInCategory.length > 0 ? productsInCategory.map(p => {
                             let rowClass = 'border-t border-gray-200 flex items-center justify-between p-3 gap-4';
                             if (p.stock < 50) rowClass += ' bg-red-50'; else if (p.stock < 100) rowClass += ' bg-yellow-50';
                             return `
                             <div class="${rowClass}">
                                <div class="w-12 h-12 flex-shrink-0 rounded-lg bg-gray-100 flex items-center justify-center text-3xl">
                                    ${p.emoji || (p.color && p.color !== '#ffffff' ? `<span class="inline-block w-6 h-6 rounded-full" style="background-color: ${p.color};"></span>` : 'üì¶')}
                                </div>
                                 <div class="flex-grow min-w-0">
                                     <p class="font-semibold truncate">${p.name}</p>
                                     <p class="text-2xl font-bold ${p.stock < 50 ? 'text-red-700' : 'text-gray-800'}">${p.stock} <span class="text-sm font-normal text-gray-500">en stock</span></p>
                                 </div>
                                 <div class="flex flex-col gap-1.5 flex-shrink-0">
                                     <button data-id="${p.id}" class="adjust-stock-btn bg-yellow-500 text-white p-2 rounded-md hover:bg-yellow-600 flex items-center justify-center"><svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button>
                                     <button data-id="${p.id}" class="delete-product-btn bg-red-500 text-white p-2 rounded-md hover:bg-red-600 flex items-center justify-center"><svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>
                                 </div>
                             </div>`;
                        }).join('') : '<p class="text-center text-gray-500 p-4 border-t">No hay productos en esta categor√≠a.</p>'}
                    </div>
                </div>
                `;
            }).join('');
        }
        
        function renderMovements() {
            const container = document.getElementById('movements-history');
            container.innerHTML = movementsCache.length === 0 ? `<p class="text-center py-8 text-gray-500">No hay movimientos.</p>` : movementsCache.map(mov => {
                const isEntry = mov.type === 'entry';
                const headerColor = isEntry ? 'bg-green-100 text-green-900' : 'bg-red-100 text-red-900';
                const isExpanded = expandedMovements.has(mov.id);
                return `
                    <div class="movement-item rounded-lg border overflow-hidden">
                        <div class="movement-header flex justify-between items-center p-2 cursor-pointer ${headerColor}" data-id="${mov.id}">
                            <p class="font-bold text-sm truncate pr-2">${mov.reason || 'Movimiento'}</p>
                            <div class="flex items-center gap-2">
                                <p class="text-xs font-mono">${new Date(mov.timestamp.seconds * 1000).toLocaleDateString()}</p>
                                <svg class="arrow-icon h-5 w-5 transition-transform ${isExpanded ? 'rotate-180' : ''}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                            </div>
                        </div>
                        <div class="movement-details accordion-content ${isExpanded ? 'open' : ''}" style="max-height: ${isExpanded ? '1000px' : '0px'};">
                            <div class="bg-white p-3 text-sm">
                                <div class="flex justify-between items-center mb-2">
                                    <p class="text-xs text-gray-500">Por: <span class="font-medium text-gray-700">${mov.responsible || 'N/A'}</span></p>
                                    <div>
                                        <button data-id="${mov.id}" class="edit-movement-btn text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded hover:bg-blue-200">Editar</button>
                                        <button data-id="${mov.id}" class="delete-movement-btn text-xs bg-red-100 text-red-800 px-2 py-1 rounded hover:bg-red-200">Eliminar</button>
                                    </div>
                                </div>
                                <ul class="list-disc pl-5 text-xs space-y-1">
                                    ${mov.items.map(item => `
                                        <li>
                                            <div class="flex justify-between items-center">
                                                <span><span class="font-semibold">${item.quantity}</span> x ${item.productName}</span>
                                                ${item.stockBefore !== undefined ? `<span class="text-xs text-gray-500 font-mono">Stock: ${item.stockBefore} ‚Üí ${item.stockAfter}</span>` : ''}
                                            </div>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function renderMovementForm(products, formType, currentItems = []) {
            const container = document.getElementById(`${formType}-items-container`);
            const searchInput = document.getElementById(`${formType}-search`);
            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
            
            const filtered = products.filter(p => p.name.toLowerCase().includes(searchTerm));
            
            container.innerHTML = filtered.length === 0 ? `<p class="text-center text-gray-500 py-4">No se encontraron productos.</p>` : filtered.map(p => {
                const currentItem = currentItems.find(item => item.productId === p.id || item.productName === p.name);
                const quantity = currentItem ? currentItem.quantity : '';
                return `
                <div class="grid grid-cols-3 gap-4 items-center">
                    <label for="${formType}-${p.id}" class="col-span-2 text-gray-700">${p.name} (Stock: ${p.stock})</label>
                    <input type="number" value="${quantity}" id="${formType}-${p.id}" name="${p.id}" min="0" placeholder="0" class="col-span-1 p-2 border border-gray-300 rounded-lg w-full">
                </div>
                `
            }).join('');
        }

        function renderResponsibleSection(container, selectedResponsible = '') {
            container.innerHTML = `
                <div class="border-t pt-4">
                    <label class="block text-gray-700 font-medium mb-2">Responsable</label>
                    <div class="flex gap-2">
                        <select required class="responsible-select w-full p-3 border border-gray-300 rounded-lg">
                            <option value="">Seleccionar persona...</option>
                            ${peopleCache.map(p => `<option value="${p.name}" ${p.name === selectedResponsible ? 'selected' : ''}>${p.name}</option>`).join('')}
                        </select>
                        <input type="text" class="new-person-input p-3 border border-gray-300 rounded-lg" placeholder="Nueva persona">
                        <button type="button" class="add-person-btn bg-gray-600 text-white px-4 rounded-lg hover:bg-gray-700 font-bold">+</button>
                    </div>
                </div>
            `;
        }

        function populateCategoryDropdowns(categories) {
            const optionsHtml = categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            document.getElementById('adjust-product-category').innerHTML = optionsHtml;
            document.getElementById('add-product-category').innerHTML = `<option value="">Seleccionar categor√≠a...</option>${optionsHtml}<option value="new">-- Crear Nueva Categor√≠a --</option>`;
        }
        
        document.getElementById('add-product-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const responsible = form.querySelector('.responsible-select').value;
            if (!responsible) {
                showAlert('Por favor, selecciona un responsable.');
                return;
            }
            
            let categoryId = document.getElementById('add-product-category').value;
            const productName = document.getElementById('add-product-name').value.trim();
            const newCategoryName = document.getElementById('new-category-name').value.trim();

            if (categoryId === 'new') {
                if (!newCategoryName) {
                    showAlert('El nombre de la nueva categor√≠a no puede estar vac√≠o.');
                    return;
                }
                const newCatRef = await addDoc(categoriesCollection, {
                    name: newCategoryName,
                    emoji: document.getElementById('new-category-emoji').value
                });
                categoryId = newCatRef.id;
            } else if (!categoryId) {
                showAlert('Por favor, selecciona una categor√≠a.');
                return;
            }

            if (productName) {
                const productData = {
                    name: productName,
                    stock: parseInt(document.getElementById('add-initial-stock').value, 10),
                    emoji: document.getElementById('add-product-emoji').value,
                    color: document.getElementById('add-product-color').value,
                    createdBy: responsible,
                    categoryId: categoryId
                };
                if (productData.color === '#ffffff') delete productData.color;
                await addDoc(productsCollection, productData);
            }

            form.reset();
            document.getElementById('new-category-fields').classList.add('hidden');
            document.getElementById('product-fields').style.display = 'block';
            closeModal(modals.addProduct);
        });

        document.getElementById('adjust-stock-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('adjust-stock-product-id').value;
            const updatedData = {
                name: document.getElementById('adjust-product-name').value,
                stock: parseInt(document.getElementById('new-stock-quantity').value, 10),
                emoji: document.getElementById('adjust-product-emoji').value,
                color: document.getElementById('adjust-product-color').value,
                categoryId: document.getElementById('adjust-product-category').value
            };
            if (updatedData.color === '#ffffff') delete updatedData.color;
            await updateDoc(doc(productsCollection, id), updatedData);
            closeModal(modals.adjustStock);
        });
        
        async function handleMovementSubmit(e, formType) {
            e.preventDefault();
            const isExit = formType.includes('exit');
            const form = e.target;
            const responsible = form.querySelector('.responsible-select').value;
            if (!responsible) {
                showAlert('Por favor, selecciona un responsable.');
                return;
            }

            const movementItems = [];
            const container = document.getElementById(`${formType}-items-container`);
            container.querySelectorAll('input[type="number"]').forEach(input => {
                const quantity = parseInt(input.value, 10);
                if (quantity > 0) {
                    const product = productsCache.find(p => p.id === input.name);
                    const stockBefore = product.stock;
                    const stockAfter = isExit ? stockBefore - quantity : stockBefore + quantity;
                    movementItems.push({ 
                        productId: product.id, 
                        productName: product.name, 
                        quantity,
                        stockBefore,
                        stockAfter
                    });
                }
            });
            
            if (movementItems.length > 0) {
                const batch = writeBatch(db);
                movementItems.forEach(item => {
                     batch.update(doc(productsCollection, item.productId), { stock: item.stockAfter });
                });
                
                const reason = isExit ? document.getElementById('exit-reason').value : document.getElementById('entry-reason').value;
                const movementData = { items: movementItems, timestamp: Timestamp.now(), type: isExit ? 'exit' : 'entry', responsible, reason };
                batch.set(doc(movementsCollection), movementData);
                
                await batch.commit();
            }
            form.reset();
            closeModal(isExit ? modals.registerExit : modals.registerEntry);
        }

        document.getElementById('edit-movement-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const movementId = form.querySelector('#edit-movement-id').value;
            const movementType = form.querySelector('#edit-movement-type').value;
            const originalItems = JSON.parse(form.querySelector('#original-movement-items').value);
            const responsible = form.querySelector('.responsible-select').value;
            const reason = form.querySelector('#edit-movement-reason').value;

            const newItems = [];
            form.querySelector('#edit-movement-items-container').querySelectorAll('input[type="number"]').forEach(input => {
                const quantity = parseInt(input.value, 10);
                if (quantity > 0) {
                    const product = productsCache.find(p => p.id === input.name);
                    newItems.push({ productId: product.id, productName: product.name, quantity });
                }
            });

            const stockChanges = new Map();
            originalItems.forEach(item => {
                const change = movementType === 'exit' ? item.quantity : -item.quantity;
                stockChanges.set(item.productId, (stockChanges.get(item.productId) || 0) + change);
            });
            newItems.forEach(item => {
                const change = movementType === 'exit' ? -item.quantity : item.quantity;
                stockChanges.set(item.productId, (stockChanges.get(item.productId) || 0) + change);
            });
            
            const batch = writeBatch(db);
            const newItemsWithStock = [];

            for (const [productId, change] of stockChanges.entries()) {
                const product = productsCache.find(p => p.id === productId);
                if(product) {
                    const newStock = product.stock + change;
                    batch.update(doc(productsCollection, productId), { stock: newStock });
                }
            }

            for(const item of newItems) {
                const product = productsCache.find(p => p.id === item.productId);
                const originalItem = originalItems.find(oi => oi.productId === item.productId);
                const stockBefore = originalItem ? originalItem.stockBefore : product.stock;
                const stockAfter = movementType === 'exit' ? stockBefore - item.quantity : stockBefore + item.quantity;
                newItemsWithStock.push({...item, stockBefore, stockAfter});
            }

            const updatedMovementData = { items: newItemsWithStock, responsible, reason, timestamp: Timestamp.now(), type: movementType };
            batch.update(doc(movementsCollection, movementId), updatedMovementData);

            await batch.commit();
            closeModal(modals.editMovement);
        });

        function exportToExcel() {
            const stockData = productsCache.map(p => {
                const category = categoriesCache.find(c => c.id === p.categoryId);
                return { 'Categor√≠a': category ? category.name : 'N/A', 'Producto': p.name, 'Stock Actual': p.stock };
            });
            const stockSheet = XLSX.utils.json_to_sheet(stockData);
            stockSheet['!cols'] = [{ wch: 25 }, { wch: 50 }, { wch: 15 }];
            
            const historyData = movementsCache.flatMap(mov => mov.items.map(item => ({ 'Motivo/Evento': mov.reason, 'Responsable': mov.responsible, 'Fecha': new Date(mov.timestamp.seconds * 1000).toLocaleString(), 'Tipo': mov.type === 'entry' ? 'Entrada' : 'Salida', 'Producto': item.productName, 'Cantidad': item.quantity, 'Stock Antes': item.stockBefore, 'Stock Despu√©s': item.stockAfter })));
            const historySheet = XLSX.utils.json_to_sheet(historyData);
            historySheet['!cols'] = [{ wch: 30 }, { wch: 20 }, { wch: 20 }, { wch: 10 }, { wch: 50 }, { wch: 10 }, { wch: 15 }, { wch: 15 }];

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, stockSheet, "Stock Actual");
            XLSX.utils.book_append_sheet(wb, historySheet, "Historial de Movimientos");
            XLSX.writeFile(wb, "Reporte_Inventario.xlsx");
        }

        document.getElementById('add-product-category').addEventListener('change', (e) => {
            const isNew = e.target.value === 'new';
            document.getElementById('new-category-fields').classList.toggle('hidden', !isNew);
            document.getElementById('product-fields').style.display = isNew ? 'none' : 'block';
        });
        document.getElementById('register-exit-form').addEventListener('submit', (e) => handleMovementSubmit(e, 'exit'));
        document.getElementById('register-entry-form').addEventListener('submit', (e) => handleMovementSubmit(e, 'entry'));
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('add-person-btn')) {
                const input = e.target.previousElementSibling;
                const newName = input.value.trim();
                if (newName && !peopleCache.some(p => p.name === newName)) {
                    addDoc(peopleCollection, { name: newName });
                    input.value = '';
                }
            }
        });
        
        document.getElementById('inventory-container').addEventListener('click', (e) => {
            const catHeader = e.target.closest('.category-header');
            if(catHeader) {
                const categoryId = catHeader.dataset.id;
                if (expandedCategories.has(categoryId)) {
                    expandedCategories.delete(categoryId);
                } else {
                    expandedCategories.add(categoryId);
                }
                const content = catHeader.nextElementSibling;
                const arrow = catHeader.querySelector('.arrow-icon');
                const isOpen = content.classList.toggle('open');
                arrow.classList.toggle('rotate-180', isOpen);
                content.style.maxHeight = isOpen ? content.scrollHeight + "px" : '0px';
            }
        });

        document.getElementById('movements-history').addEventListener('click', (e) => {
             const movHeader = e.target.closest('.movement-header');
             if (movHeader) {
                const movementId = movHeader.dataset.id;
                if (expandedMovements.has(movementId)) {
                    expandedMovements.delete(movementId);
                } else {
                    expandedMovements.add(movementId);
                }
                 const content = movHeader.nextElementSibling;
                 const arrow = movHeader.querySelector('.arrow-icon');
                 const isOpen = content.classList.toggle('open');
                 arrow.classList.toggle('rotate-180', isOpen);
                 content.style.maxHeight = isOpen ? content.scrollHeight + "px" : '0px';
             }

             const editBtn = e.target.closest('.edit-movement-btn');
             if(editBtn) {
                const movement = movementsCache.find(m => m.id === editBtn.dataset.id);
                document.getElementById('edit-movement-id').value = movement.id;
                document.getElementById('edit-movement-type').value = movement.type;
                document.getElementById('original-movement-items').value = JSON.stringify(movement.items);
                document.getElementById('edit-movement-reason').value = movement.reason;
                renderResponsibleSection(modals.editMovement.querySelector('.responsible-section-container'), movement.responsible);
                renderMovementForm(productsCache, 'edit-movement', movement.items);
                openModal(modals.editMovement);
             }

             const deleteBtn = e.target.closest('.delete-movement-btn');
             if (deleteBtn) {
                showConfirm('¬øEst√°s seguro? Esta acci√≥n revertir√° el stock y eliminar√° el registro permanentemente.', () => {
                    const movement = movementsCache.find(m => m.id === deleteBtn.dataset.id);
                    const batch = writeBatch(db);
                    movement.items.forEach(item => {
                        const product = productsCache.find(p => p.id === item.productId);
                        if(product) {
                            const newStock = movement.type === 'exit' ? product.stock + item.quantity : product.stock - item.quantity;
                            batch.update(doc(productsCollection, item.productId), { stock: newStock });
                        }
                    });
                    batch.delete(doc(movementsCollection, movement.id));
                    batch.commit();
                });
             }
        });

        async function main() {
            await signInAnonymously(auth);
            
            onSnapshot(query(categoriesCollection), snap => { 
                categoriesCache = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => a.name.localeCompare(b.name));
                populateCategoryDropdowns(categoriesCache);
                renderInventory();
            });
            onSnapshot(productsCollection, snap => { 
                productsCache = snap.docs.map(d => ({ id: d.id, ...d.data() })); 
                renderInventory(); 
            });
            onSnapshot(query(movementsCollection), snap => {
                movementsCache = snap.docs.map(d => ({id: d.id, ...d.data()})).sort((a, b) => b.timestamp.seconds - a.timestamp.seconds);
                renderMovements();
            });
            onSnapshot(peopleCollection, snap => {
                peopleCache = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => a.name.localeCompare(b.name));
                document.querySelectorAll('.responsible-section-container').forEach(c => renderResponsibleSection(c));
            });
            
            await seedData();
            
            document.getElementById('inventory-container').addEventListener('click', (e) => {
                const adjustBtn = e.target.closest('.adjust-stock-btn');
                const deleteBtn = e.target.closest('.delete-product-btn');
                if (adjustBtn) {
                    const product = productsCache.find(p => p.id === adjustBtn.dataset.id);
                    document.getElementById('adjust-stock-product-id').value = product.id;
                    document.getElementById('adjust-product-name').value = product.name;
                    document.getElementById('new-stock-quantity').value = product.stock;
                    document.getElementById('adjust-product-emoji').value = product.emoji || '';
                    document.getElementById('adjust-product-color').value = product.color || '#ffffff';
                    document.getElementById('adjust-product-category').value = product.categoryId;
                    openModal(modals.adjustStock);
                }
                if (deleteBtn) {
                    showConfirm('¬øEst√°s seguro de que quieres eliminar este producto? Esto no afectar√° los registros hist√≥ricos.', () => {
                        deleteDoc(doc(productsCollection, deleteBtn.dataset.id));
                    });
                }
            });

            document.getElementById('export-excel-btn').addEventListener('click', exportToExcel);
            document.getElementById('exit-search').addEventListener('input', (e) => renderMovementForm(productsCache, 'exit'));
            document.getElementById('entry-search').addEventListener('input', (e) => renderMovementForm(productsCache, 'entry'));
            document.getElementById('edit-movement-search').addEventListener('input', (e) => {
                const movement = movementsCache.find(m => m.id === document.getElementById('edit-movement-id').value);
                const currentItems = movement ? movement.items : [];
                renderMovementForm(productsCache, 'edit-movement', currentItems);
            });
        }
        main();
    </script>
</body>

</html>

